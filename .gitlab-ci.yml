---
UnitTests:
  image: registry.fedoraproject.org/fedora
  stage: test
  variables:
    JUNIT_URL: ""
  rules:
    - if: '$JUNIT_URL != ""'
      when: never
    - if: '$CI_PIPELINE_SOURCE != "merge_request_event"'
      when: never
    - when: always
  script:
    - dnf -y install python3 python3-pip iproute
    - python3 -m pip install pytest PyYAML pexpect
    - python3 -m pip install --prefix /usr/ black==19.10b0
    - python3 -m pytest nmci/test.py --junitxml=report.xml
  artifacts:
    when: always
    reports:
      junit:
        - report.xml

TestResults:
  image: registry.fedoraproject.org/fedora
  stage: test
  variables:
    JUNIT_URL: ""
  rules:
    - if: '$JUNIT_URL == ""'
      when: never
    - when: always
  script:
    - dnf -y install wget grep coreutils
    - 'for i in {1..100}; do wget -O report.xml "$JUNIT_URL" && break; sleep 5; done'
    - '[ -f report.xml ] && ! grep -F "<failure>" report.xml'
  artifacts:
    when: always
    reports:
      junit:
        - report.xml
