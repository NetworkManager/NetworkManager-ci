/plan:
    summary:
        Desktop tests for {{ component }}
    discover:
        how: fmf
    provision:
        how: local
    prepare:
    {%- if packages %}
      - name: packages
        how: install
        package:
        {%- for package in packages %}
         - {{ package }}
        {%- endfor %}
    {%- endif %}
      - name: tmt_prepare
        how: shell
        script:
          - wget --no-check-certificate https://gitlab.cee.redhat.com/desktopqe/desktop-ci/-/raw/master/fmftmt/initial_setup.sh
          - bash ./initial_setup.sh
    {%- for task in tasks %}
      - name: {{ task['name'].split('/')[-1] }}
        how: shell
        script:
        {%- if task['params'] %}
          {%- for key, value in task['params'].items() %}
          - export {{ key }}={{ value }} ;
          {%- endfor %}
        {%- endif %}
          - cd /mnt/tests{{ task['name'] }} ; make run
    {%- endfor %}
    execute:
        how: tmt
    finish:
        how: shell
        script: 
          - wget --no-check-certificate https://gitlab.cee.redhat.com/desktopqe/desktop-ci/-/raw/master/fmftmt/finish-reserve.sh
          - bash finish-reserve.sh

    /all:
        discover:
            how: fmf

    /gate:
        discover:
            how: fmf
            filter: tag:gate

    /libndp:
        discover:
            how: fmf
            filter: tag:libndp

/tests:
    {% for test in testmapper %}
    /{{ test['testname'] }}:
        test: {{ test['run'] }}
        {%- if test['dir'] != '.' %}
        path: /{{ test['dir'] }}
        {%- endif %}
        {%- if test['tags'] %}
        tag: {{ test['tags'] }}
        {%- endif %}
        {%- if test['package-deps'] %}
        require: {{ test['package-deps'] }}
        {%- endif %}
        environment:
            TEST: {{ component }}_{{ "%06d"|format(test['order']) }}_{{ test['testname'] }}
        order: {{ test['order'] }}
        {%- if mapper.default_test_timeout == test['timeout'] %}
        duration: {{ mapper.default_test_timeout }}
        {%- else %}
        duration: {{ test['timeout'] }}
        {%- endif %}
        tty: true
    {% endfor %}
